#!/usr/bin/env sh
# Log rotation service - runs every hour
# Rotates nginx logs: current -> .1 -> .1.gz -> delete

LOG_DIR="${LOG_DIR:-/tmp}"
MAX_SIZE="${MAX_SIZE:-10485760}"  # 10MB - rotate when file exceeds this size
SLEEP_SECS="${SLEEP_SECS:-3600}"

rotate_log() {
    logfile="$1"

    [ -f "$logfile" ] || return 1

    # Get file size
    size=$(stat -c %s "$logfile" 2>/dev/null || echo 0)

    # Only rotate if file is larger than MAX_SIZE
    [ "$size" -ge "$MAX_SIZE" ] || return 1

    # Delete old compressed log if exists
    [ -f "${logfile}.1.gz" ] && rm -f "${logfile}.1.gz"

    # Compress previous rotation if exists
    [ -f "${logfile}.1" ] && gzip -f "${logfile}.1"

    # Rotate current log
    mv "$logfile" "${logfile}.1"
    return 0
}

reopen_logs() {
    [ -f /run/nginx/nginx.pid ] || return 0
    pid="$(cat /run/nginx/nginx.pid 2>/dev/null || true)"
    [ -n "$pid" ] && kill -USR1 "$pid" 2>/dev/null || true
}

LOG_FILES="
${LOG_DIR}/nginx-rutorrent-access.log
${LOG_DIR}/nginx-rutorrent-error.log
${LOG_DIR}/nginx-access.log
${LOG_DIR}/nginx-error.log
"

while true; do
    # Rotate nginx logs
    rotated=0
    for log in $LOG_FILES; do
        rotate_log "$log" && rotated=1
    done
    [ "$rotated" -eq 1 ] && reopen_logs

    # Wait between checks
    sleep "$SLEEP_SECS"
done
