#!/usr/bin/env sh

# replace d.directory by d.base_path
sed -e "s|/usr/local/bin/postdl,\$d\.directory|/usr/local/bin/postdl,\$d\.base_path|g" -i /config/rtorrent/.rtorrent.rc

# replace /RPC by /RPC2
sed -e "s|'\/RPC'|'\/RPC2'|g" -i /config/rutorrent/conf/config.php

# update to php84
sed -e "s|'\/usr\/bin\/php8[23]'|'\/usr\/bin\/php84'|g" -i /config/rutorrent/conf/config.php

# replace new location of curl
sed -i -e "s/\/usr\/bin\/curl/\/usr\/local\/bin\/curl/g" /config/rutorrent/conf/config.php

# update php cli reference in legacy rtorrent configs
if [ -f /config/rtorrent/.rtorrent.rc ]; then
  sed -i -E 's#/usr/bin/php(8[0-9])?#/usr/bin/php84#g' /config/rtorrent/.rtorrent.rc
fi

# ensure pathToExternals points to packaged binaries
PHP_BIN="$(command -v php84 || command -v php || true)"
if [ -z "${PHP_BIN}" ]; then
  echo "Skip pathToExternals update; php CLI not found" >&2
else
  "${PHP_BIN}" <<'PHP'
<?php
$file = '/config/rutorrent/conf/config.php';
if (!is_file($file)) {
    fwrite(STDERR, "Skip pathToExternals update; $file not found\n");
    exit(0);
}
$cfg = file_get_contents($file);
if ($cfg === false) {
    fwrite(STDERR, "Unable to read $file\n");
    exit(1);
}
$downloadDir = getenv('DOWNLOAD_DIRECTORY') ?: '/data/downloads';
$escapedDownloadDir = addcslashes($downloadDir, "\\'");
$topPattern = '/^\s*\$topDirectory\s*=.*$/m';
$topReplacement = "\t\$topDirectory = '{$escapedDownloadDir}';";
$cfg = preg_replace($topPattern, $topReplacement, $cfg, 1, $topReplaced);
if ($topReplaced === 0) {
    $cfg = preg_replace('/(\$overwriteUploadedTorrents\s*=.*\n)/', "$1{$topReplacement}\n", $cfg, 1);
}
$scgiHost = getenv('RU_SCGI_HOST') ?: 'unix:///run/rtorrent/rtorrent.sock';
$scgiPort = getenv('RU_SCGI_PORT') ?: '0';
$cfg = preg_replace('/^\s*\$scgi_host\s*=.*$/m', "\t\$scgi_host = \"{$scgiHost}\";", $cfg, 1);
$cfg = preg_replace('/^\s*\$scgi_port\s*=.*$/m', "\t\$scgi_port = {$scgiPort};", $cfg, 1);
$replacements = [
    'php' => '/usr/bin/php84',
    'curl' => '/usr/local/bin/curl',
    'ffmpeg' => '/usr/bin/ffmpeg',
    'unrar' => '/usr/local/bin/unrar',
    'sox' => '/usr/bin/sox',
    'mediainfo' => '/usr/bin/mediainfo',
    'dumptorrent' => '/usr/local/bin/dumptorrent',
];
if (!preg_match('/\$pathToExternals\s*=\s*array\s*\((.*?)\);/s', $cfg, $match, PREG_OFFSET_CAPTURE)) {
    exit(0);
}
$content = $match[1][0];
$offset = $match[1][1];
foreach ($replacements as $key => $value) {
    $entryPattern = '/"' . preg_quote($key, '/') . '"\s*=>\s*\'[^\']*\'/';
    $replacement = '"' . $key . '" => \'' . $value . '\'';
    if (preg_match($entryPattern, $content)) {
        $content = preg_replace($entryPattern, $replacement, $content, 1);
    } else {
        $content .= "\n\t\t\"$key\"\t=> '$value',";
    }
}
$cfg = substr_replace($cfg, $content, $offset, strlen($match[1][0]));
file_put_contents($file, $cfg);
PHP
fi
